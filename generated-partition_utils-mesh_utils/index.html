
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Erfan Zare Chavoshi">
      
      
      
        <link rel="prev" href="../generated-pallas_operations-splash_attention-tpu-splash_attention_mask_info/">
      
      
        <link rel="next" href="../generated-partition_utils-t5x_partitioning/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.22">
    
    
      
        <title>Mesh Utils - FJFormer</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.732c4fb1.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#partition_utilsmesh_utils" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="FJFormer" class="md-header__button md-logo" aria-label="FJFormer" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            FJFormer
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Mesh Utils
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/erfanzar/FJFormer" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="FJFormer" class="md-nav__button md-logo" aria-label="FJFormer" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    FJFormer
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/erfanzar/FJFormer" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Bits
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Bits
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-bits-bits/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bits
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-bits-calibration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Calibration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-bits-config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Config
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-bits-int_numerics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Int Numerics
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-bits-no_numerics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    No Numerics
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-bits-numerics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Numerics
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-bits-q_dot_general/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Q Dot General
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-bits-q_flax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Q Flax
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-bits-qk/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Qk
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-bits-stochastic_rounding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Stochastic Rounding
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Checkpoint
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Checkpoint
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-checkpoint-_load/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Load
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-checkpoint-streamer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Streamer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Func
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Func
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-func-_func/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Func
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-func-loss_func/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Loss Func
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Monitor
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Monitor
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-monitor-tracker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tracker
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Optimizers
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Optimizers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-optimizers-adafactor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Adafactor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-optimizers-adamw/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Adamw
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-optimizers-lion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-optimizers-optimizer_utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Optimizer Utils
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-optimizers-rmsprop/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rmsprop
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Pallas Operations
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Pallas Operations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1" >
        
          
          <label class="md-nav__link" for="__nav_7_1" id="__nav_7_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Efficient Attention
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1">
            <span class="md-nav__icon md-icon"></span>
            Efficient Attention
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-pallas_operations-efficient_attention-efficient_attention/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Efficient Attention
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2" >
        
          
          <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Flash Attention
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            Flash Attention
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2_1" >
        
          
          <label class="md-nav__link" for="__nav_7_2_1" id="__nav_7_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Gpu
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2_1">
            <span class="md-nav__icon md-icon"></span>
            Gpu
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-pallas_operations-flash_attention-gpu-jax_flash_attn_gpu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Jax Flash Attn Gpu
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2_2" >
        
          
          <label class="md-nav__link" for="__nav_7_2_2" id="__nav_7_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tpu
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2_2">
            <span class="md-nav__icon md-icon"></span>
            Tpu
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-pallas_operations-flash_attention-tpu-jax_flash_attn_tpu/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Jax Flash Attn Tpu
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3" >
        
          
          <label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Layer Norm
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3">
            <span class="md-nav__icon md-icon"></span>
            Layer Norm
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3_1" >
        
          
          <label class="md-nav__link" for="__nav_7_3_1" id="__nav_7_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Gpu
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3_1">
            <span class="md-nav__icon md-icon"></span>
            Gpu
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-pallas_operations-layer_norm-gpu-layer_norm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Layer Norm
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_4" >
        
          
          <label class="md-nav__link" for="__nav_7_4" id="__nav_7_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Ring Attention
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_4">
            <span class="md-nav__icon md-icon"></span>
            Ring Attention
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-pallas_operations-ring_attention-ring_attention/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Ring Attention
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_5" >
        
          
          <label class="md-nav__link" for="__nav_7_5" id="__nav_7_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Rms Norm
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_5">
            <span class="md-nav__icon md-icon"></span>
            Rms Norm
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_5_1" >
        
          
          <label class="md-nav__link" for="__nav_7_5_1" id="__nav_7_5_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Gpu
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_5_1">
            <span class="md-nav__icon md-icon"></span>
            Gpu
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-pallas_operations-rms_norm-gpu-rms_norm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rms Norm
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_6" >
        
          
          <label class="md-nav__link" for="__nav_7_6" id="__nav_7_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Softmax
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_6">
            <span class="md-nav__icon md-icon"></span>
            Softmax
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_6_1" >
        
          
          <label class="md-nav__link" for="__nav_7_6_1" id="__nav_7_6_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Gpu
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_6_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_6_1">
            <span class="md-nav__icon md-icon"></span>
            Gpu
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-pallas_operations-softmax-gpu-softmax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Softmax
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_7" >
        
          
          <label class="md-nav__link" for="__nav_7_7" id="__nav_7_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Splash Attention
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_7">
            <span class="md-nav__icon md-icon"></span>
            Splash Attention
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_7_1" >
        
          
          <label class="md-nav__link" for="__nav_7_7_1" id="__nav_7_7_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tpu
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_7_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_7_1">
            <span class="md-nav__icon md-icon"></span>
            Tpu
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-pallas_operations-splash_attention-tpu-splash_attention_kernel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Splash Attention Kernel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-pallas_operations-splash_attention-tpu-splash_attention_mask/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Splash Attention Mask
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-pallas_operations-splash_attention-tpu-splash_attention_mask_info/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Splash Attention Mask Info
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Partition Utils
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Partition Utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Mesh Utils
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Mesh Utils
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils" class="md-nav__link">
    <span class="md-ellipsis">
      mesh_utils
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.create_mesh" class="md-nav__link">
    <span class="md-ellipsis">
      create_mesh
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.flatten_tree" class="md-nav__link">
    <span class="md-ellipsis">
      flatten_tree
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.get_jax_mesh" class="md-nav__link">
    <span class="md-ellipsis">
      get_jax_mesh
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.get_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      get_metrics
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.get_names_from_partition_spec" class="md-nav__link">
    <span class="md-ellipsis">
      get_names_from_partition_spec
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.get_weight_decay_mask" class="md-nav__link">
    <span class="md-ellipsis">
      get_weight_decay_mask
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.make_shard_and_gather_fns" class="md-nav__link">
    <span class="md-ellipsis">
      make_shard_and_gather_fns
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.match_partition_rules" class="md-nav__link">
    <span class="md-ellipsis">
      match_partition_rules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.named_tree_map" class="md-nav__link">
    <span class="md-ellipsis">
      named_tree_map
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.names_in_current_mesh" class="md-nav__link">
    <span class="md-ellipsis">
      names_in_current_mesh
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.tree_apply" class="md-nav__link">
    <span class="md-ellipsis">
      tree_apply
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.tree_path_to_string" class="md-nav__link">
    <span class="md-ellipsis">
      tree_path_to_string
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.with_sharding_constraint" class="md-nav__link">
    <span class="md-ellipsis">
      with_sharding_constraint
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.wrap_function_with_rng" class="md-nav__link">
    <span class="md-ellipsis">
      wrap_function_with_rng
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-partition_utils-t5x_partitioning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    T5x Partitioning
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utils
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Xrapture
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Xrapture
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-xrapture-implicit_array/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Implicit Array
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-xrapture-tracer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tracer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../generated-xrapture-xrapture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Xrapture
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils" class="md-nav__link">
    <span class="md-ellipsis">
      mesh_utils
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.create_mesh" class="md-nav__link">
    <span class="md-ellipsis">
      create_mesh
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.flatten_tree" class="md-nav__link">
    <span class="md-ellipsis">
      flatten_tree
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.get_jax_mesh" class="md-nav__link">
    <span class="md-ellipsis">
      get_jax_mesh
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.get_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      get_metrics
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.get_names_from_partition_spec" class="md-nav__link">
    <span class="md-ellipsis">
      get_names_from_partition_spec
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.get_weight_decay_mask" class="md-nav__link">
    <span class="md-ellipsis">
      get_weight_decay_mask
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.make_shard_and_gather_fns" class="md-nav__link">
    <span class="md-ellipsis">
      make_shard_and_gather_fns
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.match_partition_rules" class="md-nav__link">
    <span class="md-ellipsis">
      match_partition_rules
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.named_tree_map" class="md-nav__link">
    <span class="md-ellipsis">
      named_tree_map
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.names_in_current_mesh" class="md-nav__link">
    <span class="md-ellipsis">
      names_in_current_mesh
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.tree_apply" class="md-nav__link">
    <span class="md-ellipsis">
      tree_apply
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.tree_path_to_string" class="md-nav__link">
    <span class="md-ellipsis">
      tree_path_to_string
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.with_sharding_constraint" class="md-nav__link">
    <span class="md-ellipsis">
      with_sharding_constraint
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.fjformer.partition_utils.mesh_utils.wrap_function_with_rng" class="md-nav__link">
    <span class="md-ellipsis">
      wrap_function_with_rng
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="partition_utilsmesh_utils">partition_utils.mesh_utils</h1>


<div class="doc doc-object doc-module">



<a id="src.fjformer.partition_utils.mesh_utils"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">



<h2 id="src.fjformer.partition_utils.mesh_utils.create_mesh" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">create_mesh</span><span class="p">(</span><span class="n">axis_dims</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis_names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;dp&#39;</span><span class="p">,</span> <span class="s1">&#39;fsdp&#39;</span><span class="p">,</span> <span class="s1">&#39;tp&#39;</span><span class="p">,</span> <span class="s1">&#39;sp&#39;</span><span class="p">),</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>The create_mesh function creates a mesh object that can be used to shard arrays.</p>



  <p><span class="doc-section-title">Parameters:</span></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td><code>axis_dims</code></td>
          <td>
                <code><span title="typing.Sequence">Sequence</span>[int]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Sequence[int]: Specify the dimensions of the mesh</p>
            </div>
          </td>
          <td>
                <code>(1, -1, 1, 1)</code>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>axis_names</code></td>
          <td>
                <code><span title="typing.Sequence">Sequence</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Sequence[str]: Name the axes of the mesh</p>
            </div>
          </td>
          <td>
                <code>(&#39;dp&#39;, &#39;fsdp&#39;, &#39;tp&#39;, &#39;sp&#39;)</code>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>backend</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Specify the backend to use</p>
            </div>
          </td>
          <td>
                <code>&#39;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><span class="doc-section-title">Returns:</span></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A mesh object</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/fjformer/partition_utils/mesh_utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">create_mesh</span><span class="p">(</span>
        <span class="n">axis_dims</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis_names</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;dp&quot;</span><span class="p">,</span> <span class="s2">&quot;fsdp&quot;</span><span class="p">,</span> <span class="s2">&quot;tp&quot;</span><span class="p">,</span> <span class="s2">&quot;sp&quot;</span><span class="p">),</span> <span class="n">backend</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The create_mesh function creates a mesh object that can be used to shard arrays.</span>

<span class="sd">    :param axis_dims: Sequence[int]: Specify the dimensions of the mesh</span>
<span class="sd">    :param axis_names: Sequence[str]: Name the axes of the mesh</span>
<span class="sd">    :param backend: Specify the backend to use</span>
<span class="sd">    :return: A mesh object</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">array_devices</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">devices</span><span class="p">()</span> <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">jax</span><span class="o">.</span><span class="n">devices</span><span class="p">(</span><span class="n">backend</span><span class="p">)),</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">resh</span> <span class="o">=</span> <span class="n">array_devices</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">axis_dims</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">sharding</span><span class="o">.</span><span class="n">Mesh</span><span class="p">(</span>
        <span class="n">create_device_mesh</span><span class="p">(</span><span class="n">resh</span><span class="p">),</span> <span class="n">axis_names</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="src.fjformer.partition_utils.mesh_utils.flatten_tree" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">flatten_tree</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">is_leaf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>The flatten_tree function takes a nested structure of arrays and returns a
dictionary mapping from string keys to the corresponding array values. The
string keys are derived from the tree path to each value, with <code>sep</code> used as
the separator between levels in the tree. For example:</p>



  <p><span class="doc-section-title">Parameters:</span></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td><code>xs</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Store the tree structure</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>is_leaf</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Determine if a node is a leaf</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>sep</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Specify the separator between each key in the path</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><span class="doc-section-title">Returns:</span></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dict of flattened tree paths to values</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/fjformer/partition_utils/mesh_utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">flatten_tree</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">is_leaf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The flatten_tree function takes a nested structure of arrays and returns a</span>
<span class="sd">    dictionary mapping from string keys to the corresponding array values. The</span>
<span class="sd">    string keys are derived from the tree path to each value, with `sep` used as</span>
<span class="sd">    the separator between levels in the tree. For example:</span>

<span class="sd">    :param xs: Store the tree structure</span>
<span class="sd">    :param is_leaf: Determine if a node is a leaf</span>
<span class="sd">    :param sep: Specify the separator between each key in the path</span>
<span class="sd">    :return: A dict of flattened tree paths to values</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">flattened</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">tree_flatten_with_path</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">is_leaf</span><span class="o">=</span><span class="n">is_leaf</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">flattened</span><span class="p">:</span>
        <span class="n">output</span><span class="p">[</span><span class="n">tree_path_to_string</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">output</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="src.fjformer.partition_utils.mesh_utils.get_jax_mesh" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_jax_mesh</span><span class="p">(</span><span class="n">axis_dims</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>The get_jax_mesh function takes a string of the form:
    &lt;axis_dims&gt;
where axis_dims is a comma-separated list of dimensions, each dimension being either:
    &lt;name&gt;:&lt;dim&gt;  or  &lt;dim&gt;
If there are no names, then the default names 'x', 'y', and 'z' will be used. If there are fewer than three dimensions, then the remaining dimensions will be set to 1. For example:</p>



  <p><span class="doc-section-title">Parameters:</span></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td><code>axis_dims</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Specify the dimensions of the mesh</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>names</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Specify the names of the dimensions in</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><span class="doc-section-title">Returns:</span></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A mesh object</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/fjformer/partition_utils/mesh_utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_jax_mesh</span><span class="p">(</span><span class="n">axis_dims</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The get_jax_mesh function takes a string of the form:</span>
<span class="sd">        &amp;lt;axis_dims&amp;gt;</span>
<span class="sd">    where axis_dims is a comma-separated list of dimensions, each dimension being either:</span>
<span class="sd">        &amp;lt;name&amp;gt;:&amp;lt;dim&amp;gt;  or  &amp;lt;dim&amp;gt;</span>
<span class="sd">    If there are no names, then the default names &#39;x&#39;, &#39;y&#39;, and &#39;z&#39; will be used. If there are fewer than three dimensions, then the remaining dimensions will be set to 1. For example:</span>

<span class="sd">    :param axis_dims: Specify the dimensions of the mesh</span>
<span class="sd">    :param names: Specify the names of the dimensions in</span>
<span class="sd">    :return: A mesh object</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">axis_dims</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">):</span>
        <span class="n">mesh_axis_splitting</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">axis_dims</span> <span class="o">=</span> <span class="n">axis_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mesh_axis_splitting</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">axis_dims</span><span class="p">:</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dim_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">axis_dims</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span>
            <span class="n">dims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">dim</span><span class="p">))</span>
            <span class="n">dim_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dim_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">axis_dims</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
        <span class="n">dim_names</span> <span class="o">=</span> <span class="n">names</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
    <span class="n">mesh_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">device_count</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">mesh_axis_splitting</span><span class="p">:</span>
        <span class="n">physical_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">devices</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mesh_shape</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">physical_mesh</span> <span class="o">=</span> <span class="n">mesh_utils</span><span class="o">.</span><span class="n">create_device_mesh</span><span class="p">(</span><span class="n">mesh_shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Mesh</span><span class="p">(</span><span class="n">physical_mesh</span><span class="p">,</span> <span class="n">dim_names</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="src.fjformer.partition_utils.mesh_utils.get_metrics" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">unreplicate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>The get_metrics function is a helper function that takes the metrics dictionary
returned by the training loop and converts it to a format that can be used for
plotting. It does this in two ways:</p>



  <p><span class="doc-section-title">Parameters:</span></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td><code>metrics</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Store the metrics that we want to track</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>unreplicate</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Convert the metrics from a replicated</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>stack</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Stack the metrics in a list</p>
            </div>
          </td>
          <td>
                <code>False</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><span class="doc-section-title">Returns:</span></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dictionary of metrics</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/fjformer/partition_utils/mesh_utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_metrics</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">unreplicate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The get_metrics function is a helper function that takes the metrics dictionary</span>
<span class="sd">    returned by the training loop and converts it to a format that can be used for</span>
<span class="sd">    plotting. It does this in two ways:</span>

<span class="sd">    :param metrics: Store the metrics that we want to track</span>
<span class="sd">    :param unreplicate: Convert the metrics from a replicated</span>
<span class="sd">    :param stack: Stack the metrics in a list</span>
<span class="sd">    :return: A dictionary of metrics</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">unreplicate</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">flax</span><span class="o">.</span><span class="n">jax_utils</span><span class="o">.</span><span class="n">unreplicate</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">device_get</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stack</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_map</span><span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="o">*</span><span class="n">metrics</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="src.fjformer.partition_utils.mesh_utils.get_names_from_partition_spec" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_names_from_partition_spec</span><span class="p">(</span><span class="n">partition_specs</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>The get_names_from_partition_spec function takes a partition_specs argument, which is either a dictionary or list.
If it's a dictionary, the function converts it to a list of values. Then for each item in the partition_specs list:
    If the item is None, continue (do nothing) and move on to next iteration of loop.
    If the item is an instance of str (i.e., if it's just one string), add that string to names set and move on to next iteration of loop.
    Otherwise (if not None or str), call get_names_from_partition_spec recurs</p>



  <p><span class="doc-section-title">Parameters:</span></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td><code>partition_specs</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Specify the partitioning of the data</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><span class="doc-section-title">Returns:</span></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of names</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/fjformer/partition_utils/mesh_utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_names_from_partition_spec</span><span class="p">(</span><span class="n">partition_specs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The get_names_from_partition_spec function takes a partition_specs argument, which is either a dictionary or list.</span>
<span class="sd">    If it&#39;s a dictionary, the function converts it to a list of values. Then for each item in the partition_specs list:</span>
<span class="sd">        If the item is None, continue (do nothing) and move on to next iteration of loop.</span>
<span class="sd">        If the item is an instance of str (i.e., if it&#39;s just one string), add that string to names set and move on to next iteration of loop.</span>
<span class="sd">        Otherwise (if not None or str), call get_names_from_partition_spec recurs</span>

<span class="sd">    :param partition_specs: Specify the partitioning of the data</span>
<span class="sd">    :return: A list of names</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">partition_specs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">partition_specs</span> <span class="o">=</span> <span class="n">partition_specs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">partition_specs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">names</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_names_from_partition_spec</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="src.fjformer.partition_utils.mesh_utils.get_weight_decay_mask" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_weight_decay_mask</span><span class="p">(</span><span class="n">exclusions</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Return a weight decay mask function that computes the pytree masks
according to the given exclusion rules.</p>

          <details class="quote">
            <summary>Source code in <code>src/fjformer/partition_utils/mesh_utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_weight_decay_mask</span><span class="p">(</span><span class="n">exclusions</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return a weight decay mask function that computes the pytree masks</span>
<span class="sd">        according to the given exclusion rules.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">decay</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">exclusions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">weight_decay_mask</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">named_tree_map</span><span class="p">(</span><span class="n">decay</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">weight_decay_mask</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="src.fjformer.partition_utils.mesh_utils.make_shard_and_gather_fns" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">make_shard_and_gather_fns</span><span class="p">(</span><span class="n">partition_specs</span><span class="p">,</span> <span class="n">dtype_specs</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>The make_shard_and_gather_fns function takes in a partition_specs and dtype_specs,
and returns two functions: shard_fns and gather_fns. The shard function is used to
shard the input tensor into the specified partitions. The gather function is used to
gather all the shards back together into one tensor.</p>



  <p><span class="doc-section-title">Parameters:</span></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td><code>partition_specs</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Specify the sharding of the input tensor</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>dtype_specs</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Specify the dtype of the tensor</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><span class="doc-section-title">Returns:</span></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A tuple of functions</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/fjformer/partition_utils/mesh_utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">make_shard_and_gather_fns</span><span class="p">(</span><span class="n">partition_specs</span><span class="p">,</span> <span class="n">dtype_specs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The make_shard_and_gather_fns function takes in a partition_specs and dtype_specs,</span>
<span class="sd">    and returns two functions: shard_fns and gather_fns. The shard function is used to</span>
<span class="sd">    shard the input tensor into the specified partitions. The gather function is used to</span>
<span class="sd">    gather all the shards back together into one tensor.</span>

<span class="sd">    :param partition_specs: Specify the sharding of the input tensor</span>
<span class="sd">    :param dtype_specs: Specify the dtype of the tensor</span>
<span class="sd">    :return: A tuple of functions</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">float_dtypes</span> <span class="o">=</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_to_dtype_fn</span><span class="p">(</span><span class="n">dtype_spec</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">to_dtype</span><span class="p">(</span><span class="n">tensor</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dtype_specs</span> <span class="ow">in</span> <span class="n">float_dtypes</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">float_dtypes</span><span class="p">:</span>
                <span class="c1"># force np array to jax numpy array</span>
                <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype_specs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dtype_spec</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="s1">&#39;dtype&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype_spec</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">to_dtype</span>

    <span class="k">def</span> <span class="nf">make_shard_fn</span><span class="p">(</span><span class="n">partition_spec</span><span class="p">,</span> <span class="n">dtype_spec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">jax_shard_function</span> <span class="o">=</span> <span class="n">pjit</span><span class="p">(</span>
            <span class="n">make_to_dtype_fn</span><span class="p">(</span><span class="n">dtype_spec</span><span class="p">),</span>
            <span class="n">in_shardings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">out_shardings</span><span class="o">=</span><span class="n">partition_spec</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">shard_fn</span><span class="p">(</span><span class="n">tensor</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">jax_shard_function</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span><span class="o">.</span><span class="n">block_until_ready</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">shard_fn</span>

    <span class="k">def</span> <span class="nf">make_gather_fn</span><span class="p">(</span><span class="n">partition_spec</span><span class="p">,</span> <span class="n">dtype_spec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">jax_gather_fn</span> <span class="o">=</span> <span class="n">pjit</span><span class="p">(</span>
            <span class="n">make_to_dtype_fn</span><span class="p">(</span><span class="n">dtype_spec</span><span class="p">),</span>
            <span class="n">in_shardings</span><span class="o">=</span><span class="n">partition_spec</span><span class="p">,</span>
            <span class="n">out_shardings</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">gather_fn</span><span class="p">(</span><span class="n">tensor</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">device_get</span><span class="p">(</span><span class="n">jax_gather_fn</span><span class="p">(</span><span class="n">tensor</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">gather_fn</span>

    <span class="k">if</span> <span class="n">dtype_specs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dtype_specs</span> <span class="ow">in</span> <span class="n">float_dtypes</span><span class="p">:</span>
        <span class="n">shard_fns</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">tree_map</span><span class="p">(</span><span class="n">make_shard_fn</span><span class="p">,</span> <span class="n">partition_specs</span><span class="p">)</span>
        <span class="n">gather_fns</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">tree_map</span><span class="p">(</span><span class="n">make_gather_fn</span><span class="p">,</span> <span class="n">partition_specs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shard_fns</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">tree_map</span><span class="p">(</span>
            <span class="n">make_shard_fn</span><span class="p">,</span> <span class="n">partition_specs</span><span class="p">,</span> <span class="n">dtype_specs</span>
        <span class="p">)</span>
        <span class="n">gather_fns</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">tree_map</span><span class="p">(</span>
            <span class="n">make_gather_fn</span><span class="p">,</span> <span class="n">partition_specs</span><span class="p">,</span> <span class="n">dtype_specs</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">shard_fns</span><span class="p">,</span> <span class="n">gather_fns</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="src.fjformer.partition_utils.mesh_utils.match_partition_rules" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">match_partition_rules</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Returns a pytree of PartitionSpec according to rules. Supports handling
Flax TrainState and Optax optimizer state.</p>

          <details class="quote">
            <summary>Source code in <code>src/fjformer/partition_utils/mesh_utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">match_partition_rules</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Returns a pytree of PartitionSpec according to rules. Supports handling</span>
<span class="sd">        Flax TrainState and Optax optimizer state.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_partition_spec</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">leaf</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">leaf</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">leaf</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot; Don&#39;t partition scalar values. &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">PS</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rule</span><span class="p">,</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ps</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Partition rule not found for param: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">named_tree_map</span><span class="p">(</span><span class="n">get_partition_spec</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="src.fjformer.partition_utils.mesh_utils.named_tree_map" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">named_tree_map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span><span class="p">,</span> <span class="n">is_leaf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>An extended version of jax.tree_util.tree_map, where the mapped function
f takes both the name (path) and the tree leaf as input.</p>

          <details class="quote">
            <summary>Source code in <code>src/fjformer/partition_utils/mesh_utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">named_tree_map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span><span class="p">,</span> <span class="n">is_leaf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; An extended version of jax.tree_util.tree_map, where the mapped function</span>
<span class="sd">        f takes both the name (path) and the tree leaf as input.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">tree_map_with_path</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">path</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">r</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">tree_path_to_string</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">r</span><span class="p">),</span>
        <span class="n">tree</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span><span class="p">,</span>
        <span class="n">is_leaf</span><span class="o">=</span><span class="n">is_leaf</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="src.fjformer.partition_utils.mesh_utils.names_in_current_mesh" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">names_in_current_mesh</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>The names_in_current_mesh function is used to check if a set of names are in the current mesh.</p>



  <p><span class="doc-section-title">Parameters:</span></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td><code>*names</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Pass in a list of names to the function</p>
            </div>
          </td>
          <td>
                <code>()</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><span class="doc-section-title">Returns:</span></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A boolean indicating whether</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/fjformer/partition_utils/mesh_utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">names_in_current_mesh</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The names_in_current_mesh function is used to check if a set of names are in the current mesh.</span>

<span class="sd">    :param *names: Pass in a list of names to the function</span>
<span class="sd">    :return: A boolean indicating whether</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mesh_axis_names</span> <span class="o">=</span> <span class="n">pxla</span><span class="o">.</span><span class="n">thread_resources</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">physical_mesh</span><span class="o">.</span><span class="n">axis_names</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">mesh_axis_names</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="src.fjformer.partition_utils.mesh_utils.tree_apply" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">tree_apply</span><span class="p">(</span><span class="n">fns</span><span class="p">,</span> <span class="n">tree</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>The tree_apply function is a generalization of the map function.
It takes two arguments: a pytree of functions and a pytree of values.
The tree_apply function applies each function in the first argument to its corresponding value in the second argument,
and returns a new pytree with these results.</p>



  <p><span class="doc-section-title">Parameters:</span></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td><code>fns</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Apply the functions to the tree</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>tree</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Apply the function to each element in the tree</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><span class="doc-section-title">Returns:</span></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A pytree of the same structure as the input</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/fjformer/partition_utils/mesh_utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">tree_apply</span><span class="p">(</span><span class="n">fns</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The tree_apply function is a generalization of the map function.</span>
<span class="sd">    It takes two arguments: a pytree of functions and a pytree of values.</span>
<span class="sd">    The tree_apply function applies each function in the first argument to its corresponding value in the second argument,</span>
<span class="sd">    and returns a new pytree with these results.</span>

<span class="sd">    :param fns: Apply the functions to the tree</span>
<span class="sd">    :param tree: Apply the function to each element in the tree</span>
<span class="sd">    :return: A pytree of the same structure as the input</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">tree_map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">fn</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">fn</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">fns</span><span class="p">,</span> <span class="n">tree</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="src.fjformer.partition_utils.mesh_utils.tree_path_to_string" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">tree_path_to_string</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>The tree_path_to_string function takes a tree path and returns a string representation of it.</p>



  <p><span class="doc-section-title">Parameters:</span></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td><code>path</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Specify the path of the tree</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr class="doc-section-item">
          <td><code>sep</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Join the keys with a separator</p>
            </div>
          </td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>



  <p><span class="doc-section-title">Returns:</span></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr class="doc-section-item">
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A tuple of strings</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>src/fjformer/partition_utils/mesh_utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">tree_path_to_string</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The tree_path_to_string function takes a tree path and returns a string representation of it.</span>

<span class="sd">    :param path: Specify the path of the tree</span>
<span class="sd">    :param sep: Join the keys with a separator</span>
<span class="sd">    :return: A tuple of strings</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">SequenceKey</span><span class="p">):</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">idx</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">DictKey</span><span class="p">):</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">GetAttrKey</span><span class="p">):</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_util</span><span class="o">.</span><span class="n">FlattenedIndexKey</span><span class="p">):</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">sep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="src.fjformer.partition_utils.mesh_utils.with_sharding_constraint" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">with_sharding_constraint</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">partition_specs</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>A smarter version of with_sharding_constraint that only applies the
constraint if the current mesh contains the axes in the partition specs.</p>

          <details class="quote">
            <summary>Source code in <code>src/fjformer/partition_utils/mesh_utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">with_sharding_constraint</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">partition_specs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; A smarter version of with_sharding_constraint that only applies the</span>
<span class="sd">        constraint if the current mesh contains the axes in the partition specs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">axis_names</span> <span class="o">=</span> <span class="n">get_names_from_partition_spec</span><span class="p">(</span><span class="n">partition_specs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">names_in_current_mesh</span><span class="p">(</span><span class="o">*</span><span class="n">axis_names</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">_with_sharding_constraint</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">partition_specs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="src.fjformer.partition_utils.mesh_utils.wrap_function_with_rng" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">wrap_function_with_rng</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>To be used as decorator, automatically bookkeep a RNG for the wrapped function.</p>

          <details class="quote">
            <summary>Source code in <code>src/fjformer/partition_utils/mesh_utils.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">wrap_function_with_rng</span><span class="p">(</span><span class="n">rng</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; To be used as decorator, automatically bookkeep a RNG for the wrapped function. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">wrap_function</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">rng</span>
            <span class="n">rng</span><span class="p">,</span> <span class="n">split_rng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="n">split_rng</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wrapped</span>

    <span class="k">return</span> <span class="n">wrap_function</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Erfan Zare Chavoshi-FJFormer
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.5cfa9459.min.js"></script>
      
    
  </body>
</html>